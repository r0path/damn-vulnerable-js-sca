import { ExploitCVE202121315Request, ExploitCVE202121315Response } from '../../shared/vulnerability/CVE202121315';
import si from 'systeminformation';

export const exploitCVE202121315 = async (
  args: ExploitCVE202121315Request,
  context: any,
): Promise<ExploitCVE202121315Response> => {

  const systemInformation = await new Promise((resolve, reject) => {
    /*
    Note: args.query is a string[], but the `services` function only expects a string... or so it says.
    This is a slightly contrived example as in reality you would probably only ever pass a string, but
    this other POC shows how this can be confused with a normal REST api pattern:
    https://github.com/ForbiddenProgrammer/CVE-2021-21315-PoC/blob/master/index.js#L11
    */

    // Sanitize and validate args.query before passing to systeminformation to prevent command injection.
    let serviceQuery: string | undefined;
    if (Array.isArray(args.query)) {
      serviceQuery = args.query.length > 0 ? args.query[0] : undefined;
    } else if (typeof args.query === 'string') {
      serviceQuery = args.query;
    } else {
      serviceQuery = undefined;
    }

    // Only allow simple service name characters: letters, numbers, dot, underscore, hyphen and spaces.
    // Reject suspicious input instead of forwarding it to the vulnerable library.
    if (serviceQuery && !/^[A-Za-z0-9._\-\s]+$/.test(serviceQuery)) {
      resolve(new Error('Invalid query parameter'));
      return;
    }

    const _services = serviceQuery ? si.services(serviceQuery) : si.services();
    _services.then((data) => {
      resolve(data);
    }).catch(e => {
      resolve(e);
    });
  });

  return {
    info: systemInformation
  }
}